# 深入JavaScript 之异步编程

**这一章节主要从以下几个部分讲起**

1. 理解异步
2. EventLoop
3. 异步编程方法-发布订阅
4. 深入理解promise
5. Generator函数
6. 深入理解async/await



## 1. 理解异步

#### 同步与异步

首先我们得清楚的知道，什么是同步，什么是异步？

通俗的来讲，**同步**指的是 **调用之后得到的结果，才可以去做别的任务**

而**异步**指的是 **调用之后先不管结果，继续再干别的任务**



在深一步了解异步相关内容之前我们先来了解两个重要的概念。

+ 进程

> 进程是程序运行的实例，同一个程序可以产生多个进程，一个进程有可以包含一个或者多个线程

+ 线程

> 线程是操作系统能够运算调度的最小单位，一次只能执行一个任务，有自己的调用栈，寄存器环境，同一进程的线程共享进程资源。



#### JavaScript单线程

那么，问题就又来了，我们知道JS是单线程的，那么**单线程的JS又是如何实现一步的呢？**

答案呢，其实就是**单线程的JS是通过浏览器内核多线程实现异步**



我们来深入的了解一下浏览器相关工作原理吧。

以开源的Chromium为例

**浏览器的进程**

+ 浏览器进程
+ 渲染进程（重点展开介绍）
+ GPU进程
+ 网络进程
+ 插件进程

**渲染进程又包含**

+ GUI线程

> 渲染布局（页面的html，css，js，构建DOM树和渲染树就是GUI线程的工作）

+ JS引擎线程

> 解析、执行JS程序（chrome v8引擎），**JS引擎线程只有一个，这也是为什么我们所说的js是单线程的原因，其实呢语言是没有单线程多线程之说的，因为解释这个语言的引擎是单线程的，所以我们说js是单线程的**
>
> **JS引擎线程与GUI线程互斥，因为JS引擎线程也可以操作DOM**，容易造成混乱
>
> 尽量控制js文件的大小，不要让js执行时间太长

+ 定时触发器线程

> setTimeout
>
> setInterval

+ 事件触发线程

> 将满足触发条件的事件放入任务队列（异步事件放入任务队列）

+ 异步HTTP请求线程

> 处理ajax请求的线程
>
> XHR所在线程
>
> 如果请求完成时有回调函数，它就会通知事件触发线程往任务队列里面添加事件



知道了浏览器是如何进行工作的之后，我们回顾一下**前端常见的有哪些异步场景**?

+ 定时器
+ 网络请求
+ 事件绑定
+ ES6 Promise



#### 定时器

##### 定时器的执行过程

> Event Loop

1. 主线程--执行栈（代码是在执行栈中执行）
2. web APIs--setTimeout（webAPi可以理解成浏览器提供的一种能力比如setTimeout）
3. 定时器线程--计时2s
4. 事件触发线程（事件触发线程将定时器事件放入任务队列）
5. 任务队列--异步任务

```
顺序如下：
1.调用webApi(setTimeout)
2.定时器线程计数2s
3.事件触发线程将定时器事件放入任务队列（往执行栈中加任务）
4.主线程通过EventLoop遍历任务队列（往执行栈中出任务）
```

##### 定时器应用场景

+ 防抖
+ 节流
+ 倒计时
+ 动画（会存在丢帧的问题）

##### 定时器存在的问题

1. 定时任务可能不会按时执行（如果同步任务好事很久的话，定时器任务不一定会及时执行）
2. 定时器嵌套5次之后最小间隔不能低于4ms

##### 看一个定时器的常见示例

```js
// for 循环是同步任务，所以等for 执行完之后才会去执行定时器这个异步任务, var作用域是全局的，没有块级作用域
for (var i = 1; i <= 10; i ++) {
    setTimeout(function() {
        console.log(i)
    }, 1000 * i)
}
```

```
// 利用函数闭包构建作用域
for (var i = 1; i <= 10; i ++) {
    (function(i) {
        setTimeout(function() {
            console.log(i)
        }, 1000 * i)
    })(i)
}
```

```
// ES6新增的let 块级作用域
for (let i = 1; i <= 10; i ++) {
    setTimeout(function() {
        console.log(i)
    }, 1000 * i)
}
```



## 2. Event Loop机制（微观角度看异步）